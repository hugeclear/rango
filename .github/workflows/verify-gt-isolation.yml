name: Verify GT Isolation
on:
  pull_request:
    paths:
      - 'scripts/**'
      - '.github/workflows/verify-gt-isolation.yml'

jobs:
  gt-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python が無い runner でも確実に実行できるよう明示
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Audit for GT leakage via Python (no smoke leakage)
        run: |
          python - <<'PY'
          import pathlib, sys, io

          ROOT = pathlib.Path("scripts/verification")
          ok = True

          # 監査対象: verification 配下の .py
          for p in ROOT.rglob("*.py"):
            try:
              text = p.read_text(encoding="utf-8", errors="ignore")
            except Exception:
              continue
            lines = text.splitlines()
            in_smoke_test_scope = False
            for i, line in enumerate(lines, 1):
              # Track if we're in a smoke test scope
              if "if self.format_smoke_test:" in line:
                in_smoke_test_scope = True
              elif line.strip() and not line.startswith(" ") and not line.startswith("\t"):
                # Top-level code (not indented) - exit smoke test scope
                in_smoke_test_scope = False
              
              if "ground_truth_tag" not in line:
                continue
              # コメント行は除外
              if line.lstrip().startswith("#"):
                continue
              # format-smoke-test コメントがある行は許可
              if "# format-smoke-test" in line:
                continue
              # format_smoke_test スコープ内は許可
              if in_smoke_test_scope:
                continue
              
              print(f"LEAK {p}:{i}: {line.strip()}")
              ok = False

          if not ok:
            sys.exit(1)
          print("✅ GT audit clean.")
          PY