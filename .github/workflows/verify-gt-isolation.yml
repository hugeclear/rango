name: Verify GT Isolation
on:
  pull_request:
    paths:
      - 'scripts/**'
      - '.github/workflows/verify-gt-isolation.yml'

jobs:
  gt-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python が無い runner でも確実に実行できるよう明示
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Audit for GT leakage via Python (no smoke leakage)
        run: |
          python - <<'PY'
          import pathlib, sys, io

          ROOT = pathlib.Path("scripts/verification")
          ok = True

          # 監査対象: verification 配下の .py
          for p in ROOT.rglob("*.py"):
            try:
              text = p.read_text(encoding="utf-8", errors="ignore")
            except Exception:
              continue
            lines = text.splitlines()
            for i, line in enumerate(lines, 1):
              if "ground_truth_tag" not in line:
                continue
              # コメント行は除外
              if line.lstrip().startswith("#"):
                continue
              # 直前5行に format_smoke_test があるか（簡易スコープ確認）
              ctx = "\n".join(lines[max(0, i-6):i])
              if "format_smoke_test" not in ctx:
                print(f"LEAK {p}:{i}: {line.strip()}")
                ok = False

          if not ok:
            sys.exit(1)
          print("✅ GT audit clean.")
          PY